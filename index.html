<!Doctype html>
<html>
<head>
<title>PhysicsJS</title>
<script src="physicsjs-full.js"></script>
</head>
<body>
  <div id="myDiv"><textarea id="myScript" style="width: 300px; height:200px;" value=""></textarea><button id="updateBtn" onclick="changeScript();userFunction();">Update</button></div>
  <script>
    var PVector = function(e,t,n){this.x=e||0;this.y=t||0;this.z=n||0;};PVector.prototype.fromAngle=function(t,n){if(n===r||n===null){n=new e}n.x=v.cos(t);n.y=v.sin(t);return n;};PVector.prototype.random2D=function(t){return e.fromAngle(n.random()*360,t);};PVector.prototype.random3D=function(t){var i=n.random()*360;var a=n.random()*2-1;var s=n.sqrt(1-a*a);var o=s*v.cos(i);var l=s*v.sin(i);if(t===r||t===null){t=new e(o,l,a)}else{t.set(o,l,a)}return t;};PVector.prototype.dist=function(e,t){return e.dist(t);};PVector.prototype.dot=function(e,t){return e.dot(t);};PVector.prototype.cross=function(e,t){return e.cross(t);};PVector.prototype.sub=function(t,n){return new e(t.x-n.x,t.y-n.y,t.z-n.z);};PVector.prototype.angleBetween=function(e,t){return v.acos(e.dot(t)/(e.mag()*t.mag()));};PVector.prototype.lerp=function(t,n,r){var i=new e(t.x,t.y,t.z);i.lerp(n,r);return i;};PVector.prototype.set=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.get=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.mag=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.magSq=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.setMag=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.add=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.mult=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.div=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.rotate=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.normalize=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.limit=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.heading=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.heading2D=function(t,n){var r=t.get();r[e](n);return r;};PVector.prototype.array=function(t,n){var r=t.get();r[e](n);return r;};
    var userFunction=function(){};
    var changeScript=function(){
      var theInput = document.getElementById("myScript");
      userFunction=function(){
        eval(theInput.value.replace(/world/g,"worlda"));
      };
    };
    var rigidConstraints;
    var hookObject;
    var stringObject;
    var wheely;
    var worlda;
    var jellyCube=[];
    var dist=function(x1,y1,x2,y2){
      var ret = (((x2-x1)^2)+((y2-y1)^2))^0.5;
      return ret;
    };
Physics(function(world){
worlda=world;
  var viewWidth = 1000;
  var viewHeight = 600;

  var renderer = Physics.renderer('canvas',{
  width: 1000,
  height: 600,
  });

  // add the renderer
  world.add( renderer );
  // render on each step
  world.on('step', function(){
    world.render();
  });

  // bounds of the window
  var viewportBounds = Physics.aabb(0, 0, viewWidth, viewHeight);

  // constrain objects to these bounds
  world.add(Physics.behavior('edge-collision-detection', {
      aabb: viewportBounds,
      restitution: 0.66,
      cof: 0.99
  }));
  Physics.body('wheel', 'circle', function( parent ){
        
        return {
            // no need for an init
            
            // spin the wheel at desired speed
            spin: function( speed ){
                // the wheels are spinning...
                this.state.angular.vel += speed;
            }
        };
    });
  // add a circle
  wheely=Physics.body('wheel', {
        x: 100, // x-coordinate
        y: 200, // y-coordinate
        vx: 0.2, // velocity in x-direction
        vy: 0.01, // velocity in y-direction
        radius: 20
      });
    rigidConstraints = Physics.behavior('verlet-constraints', {
        iterations: 3
    });
  world.add(wheely);
  world.add( Physics.body('convex-polygon', {
    x: 250,
    y: 50,
    vx: 0.05,
    vertices: [
        {x: 0, y: 80},
        {x: 60, y: 40},
        {x: 60, y: -40},
        {x: 0, y: -80}
    ]
}) );
  world.add( Physics.body('convex-polygon', {
    x: 350,
    y: 50,
    vx: 0.05,
    vertices: [
        {x: 0, y: 80},
        {x: 60, y: 40},
        {x: 60, y: -40},
        {x: 0, y: -80}
    ]
}) );
  /*
  var tire1=Physics.body('wheel', {
        x: 50, // x-coordinate
        y: 50, // y-coordinate
        vx: 0.2, // velocity in x-direction
        vy: 0.01, // velocity in y-direction
        radius: 20
      });
var tire2=Physics.body('wheel', {
        x: 130, // x-coordinate
        y: 50, // y-coordinate
        vx: 0.2, // velocity in x-direction
        vy: 0.01, // velocity in y-direction
        radius: 20
      });
  var car=[tire1,tire2];
  for(var xs=40;xs<=140;xs+=12){
    car.push(Physics.body('circle', {
      x:xs,
      y:10,
      vx:0.2,
      vy:0.01,
      radius:5
    }));
    car.push(Physics.body('circle', {
      x:xs,
      y:0,
      vx:0.2,
      vy:0.01,
      radius:5
    }));
}
*/
  hookObject=function(obj){
    var cfg=[0.6];
    if(arguments.length>1){
      cfg=arguments[1];
    }
    for(var i=0;i<obj.length;i++){
      for(var j=0;j<obj.length;j++){
        if(obj[i] !== obj[j]){
          rigidConstraints.distanceConstraint(obj[i],obj[j],cfg);
        }
      }
    }
  }
  stringObject=function(obj,thresh){
    var cfg=[0.6];
    if(arguments.length>2){
      cfg=arguments[2];
    }
    for(var i=0;i<obj.length;i++){
      for(var j=0;j<obj.length;j++){
        if(obj[i] !== obj[j]){
          if(Math.abs(dist(obj[i].state.pos.x,obj[i].state.pos.y,obj[j].state.pos.x,obj[j].state.pos.y))<thresh){
            rigidConstraints.distanceConstraint(obj[i],obj[j],cfg);
          }
        }
      }
    }
  }
  //hookObject(car);
  /*
  var roller=[];
  for(var t=1;t<=22;t++){
    var sx=(25*(Math.sin(t*5.9976)))+200;
    var sy=(25*(Math.cos(t*5.9976)))+200;
    roller.push(Physics.body('circle', {
      x:sx,
      y:sy,
      vx:0,
      vy:0,
      radius:2
    }));
  }
  */
  //hookObject(roller);
  for(var sx=0;sx<6;sx++){
    for(var sy=0;sy<6;sy++){
      if((!(sx>0&&sx<5))&&(!(sy>0&&sy<5))){
        jellyCube.push(Physics.body('circle', {
          x:(sx*14)+200,
          y:(sy*14)+200,
          vx:0,
          vy:0,
          radius:4
        }));
      }
      if((sy<1||sy>4)&&(sx>0&&sx<5)){
        jellyCube.push(Physics.body('circle', {
          x:(sx*14)+200,
          y:(sy*14)+200,
          vx:0,
          vy:0,
          radius:4
        }));
      }
      if((sx<1||sx>4)&&(sy>0&&sy<5)){
        jellyCube.push(Physics.body('circle', {
          x:(sx*14)+200,
          y:(sy*14)+200,
          vx:0,
          vy:0,
          radius:4
        }));
      }
    }
  }
  stringObject(jellyCube,15,0.3);
  
    world.on('render', function( data ){

        var renderer = data.renderer;
        for ( var i = 0, l = jellyCube.length; i < l; i++ ){
          for ( var j = 0, l = jellyCube.length; j < l; j++ ){
            if(jellyCube[i]!==jellyCube[j]){
              if(Math.abs(dist(jellyCube[i].state.pos.x,jellyCube[i].state.pos.y,jellyCube[j].state.pos.x,jellyCube[j].state.pos.y))<15){
                renderer.drawLine(jellyCube[i].state.pos, jellyCube[j].state.pos, {
                    strokeStyle: '#cb4b16'
                    ,lineWidth: 3
                });
              }
            }
          }
        }
    });
  world.add( rigidConstraints );
  world.add(jellyCube);
  //world.add(roller);
  //world.add(car);
  window.onkeydown=function(e){
    if(e.keyCode == 37 && e.target == document.body){
      world.on('step', function( data ){
        console.log(data);
            wheely.spin( -0.03 );
            //tire1.spin( -0.03 );
            //tire2.spin( -0.03 );
            // only execute callback once
            world.off( 'step', data.handler );
        
        });
    }else if(e.keyCode == 39 && e.target == document.body){
      world.on('step', function( data ){
        console.log(data);
            wheely.spin( 0.03 );
            //tire1.spin( 0.03 );
            //tire2.spin( 0.03 );
            // only execute callback once
            world.off( 'step', data.handler );
        });
    }
  };
  try{
    userFunction();
  }catch(err){
    console.warn(err);
  }
  
        world.add(Physics.behavior('interactive', { el: renderer.container }));
    
    var attractor = Physics.behavior('attractor', {
        order: 0,
        strength: 0.002
    });
    world.on({
        'interact:poke': function( pos ){
            world.wakeUpAll();
            attractor.position( pos );
            world.add( attractor );
        }
        ,'interact:move': function( pos ){
            attractor.position( pos );
        }
        ,'interact:release': function(){
            world.wakeUpAll();
            world.remove( attractor );
        }
    });
  // ensure objects bounce when edge collision is detected
  world.add( Physics.behavior('body-impulse-response') );
  world.add( Physics.behavior('body-collision-detection') );
world.add( Physics.behavior('sweep-prune') );
  // add some gravity
  world.add( Physics.behavior('constant-acceleration') );

  // subscribe to ticker to advance the simulation
  Physics.util.ticker.on(function( time, dt ){
      document.getElementsByClassName('pjs-layer-main')[0].width="1000";
      document.getElementsByClassName('pjs-layer-main')[0].height="600";
      world.step( time );
  });

  // start the ticker
  Physics.util.ticker.start();

});  
</script>
</body>
</html>
